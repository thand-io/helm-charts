{{- if and .Values.secrets.enabled (not .Values.secrets.existingSecret) }}
{{- $root := . }}
{{- $secretData := .Values.secrets.data | default dict }}
{{- $generateEnabled := .Values.secrets.generate.enabled }}
{{- if $generateEnabled }}
  {{- $generateLength := .Values.secrets.generate.length | default 32 | int }}
  {{- range $key := .Values.secrets.generate.keys }}
    {{- if not (hasKey $secretData $key) }}
      {{- $_ := set $secretData $key (randAlphaNum $generateLength) }}
    {{- end }}
  {{- end }}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "agent.fullname" $root }}-secrets
  namespace: {{ include "agent.namespace" $root }}
  labels:
    {{- include "agent.labels" $root | nindent 4 }}
  annotations:
    # Force secret regeneration on upgrade if auto-generation is enabled
    {{- if $generateEnabled }}
    "helm.sh/hook": "pre-install,pre-upgrade"
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": "before-hook-creation"
    {{- end }}
type: Opaque
{{- if $secretData }}
data:
  {{- range $key, $value := $secretData }}
  {{ $key }}: {{ $value | b64enc | quote }}
  {{- end }}
{{- else }}
data: {}
{{- end }}
{{- end }}